<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Sign-Out</title>
  <style>
    html,body{height:100%;margin:0;font-family:sans-serif;background:#0b1220;color:#eef;}
    .wrap{display:flex;align-items:center;justify-content:center;height:100%;}
    .card{text-align:center;padding:32px;border-radius:16px;background:#111a2b;box-shadow:0 6px 24px rgba(0,0,0,.35);width:min(720px,92vw);}
    .title{font-size:2rem;margin-bottom:8px;}
    .status{margin-top:16px;font-size:1.2rem;padding:8px 12px;border-radius:12px;display:none;background:#1e2a42;}
    .err{color:#f99;}
    .hid{position:fixed;top:-9999px;left:-9999px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="name" class="title">Ready to scan…</div>
      <div id="status" class="status">Signed Out</div>
      <div id="msg"></div>
    </div>
  </div>

  <input id="scanInput" class="hid" autocomplete="off" />
  <script src="./config.js"></script>
  <script>
    const { API_BASE, SOURCE, DEVICE_ID, AUTO_CLEAR_MS } = window.APP_CONFIG;
    const scanInput = document.getElementById('scanInput');
    const nameEl    = document.getElementById('name');
    const statusEl  = document.getElementById('status');
    const msgEl     = document.getElementById('msg');

    let buffer = '';
    ['click','focus','load'].forEach(ev => window.addEventListener(ev, () => scanInput.focus()));

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape'){ buffer=''; clearCard(); return; }
      if (e.key === 'Enter'){
        const code = buffer.trim(); buffer='';
        if (code) submit(code);
      } else if (e.key.length === 1){
        buffer += e.key;
      }
    });

    async function submit(barcode){
      setCard('Scanning…', false, '');
      try{
        const res = await fetch(`${API_BASE}?route=scan`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ barcode, source: SOURCE, deviceId: DEVICE_ID })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Scan failed');
        const s = data.student || {};
        const full = [s.FirstName, s.LastName].filter(Boolean).join(' ') || s.StudentID || 'Signed Out';
        setCard(full, true, '');
      }catch(err){
        setCard('Error', false, String(err));
      }finally{
        setTimeout(clearCard, AUTO_CLEAR_MS || 3000);
      }
    }

    function setCard(title, showSigned, msg){
      nameEl.textContent = title || '—';
      statusEl.style.display = showSigned ? 'inline-block' : 'none';
      msgEl.textContent = msg || '';
      msgEl.className = msg ? 'err' : '';
    }
    function clearCard(){ setCard('Ready to scan…', false, ''); scanInput.focus(); }
  </script>
</body>
</html>
